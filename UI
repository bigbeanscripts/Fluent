local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

local Library = loadstring(game:HttpGetAsync("https://github.com/ActualMasterOogway/Fluent-Renewed/releases/latest/download/Fluent.luau"))()
local SearchIndex = {}
local ObjectSet = {}

local OriginalCreateWindow = Library.CreateWindow
local OriginalWindowCtor = type(Library.Window) == "function" and Library.Window or nil

local function GetTitle(arg1, arg2)
	if type(arg2) == "table" and arg2.Title then return tostring(arg2.Title) end
	if type(arg1) == "table" and arg1.Title then return tostring(arg1.Title) end
	if type(arg1) == "string" then return tostring(arg1) end
	return "No Title"
end

local function GetFrameFromElement(Element)
	if typeof(Element) == "Instance" then
		return Element
	end
	if type(Element) == "table" then
		local f = rawget(Element, "Frame")
		if typeof(f) == "Instance" then return f end
	end
	return nil
end

local function RecordElement(ctx, typeName, displayTitle, elementObj)
	if not displayTitle or displayTitle == "" then return end
	if elementObj and ObjectSet[elementObj] then return end
	if elementObj then ObjectSet[elementObj] = true end

	table.insert(SearchIndex, {
		Name = displayTitle,
		Type = typeName,
		Tab = ctx.TabName or "Unknown",
		Section = (ctx.GetSection and ctx.GetSection()) or (ctx.TabName or "Unknown"),
		TabIndex = ctx.TabIndex or 1,
		Object = elementObj,
		Frame = GetFrameFromElement(elementObj)
	})
end

local function HookContainer(container, ctx)
	if not container or container.__Aliased then return container end
	container.__Aliased = true

	if container.AddToggle and not container.__HookAddToggle then
		container.__HookAddToggle = true
		local Old = container.AddToggle
		container.AddToggle = function(self, arg1, arg2, ...)
			local el = Old(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			RecordElement(ctx, "Toggle", title, el)
			return el
		end
	end

	if container.AddDropdown and not container.__HookAddDropdown then
		container.__HookAddDropdown = true
		local Old = container.AddDropdown
		container.AddDropdown = function(self, arg1, arg2, ...)
			local el = Old(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			RecordElement(ctx, "Dropdown", title, el)
			return el
		end
	end

	if container.AddButton and not container.__HookAddButton then
		container.__HookAddButton = true
		local Old = container.AddButton
		container.AddButton = function(self, arg1, arg2, ...)
			local el = Old(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			RecordElement(ctx, "Button", title, el)
			return el
		end
	end

	if container.AddParagraph and not container.__HookAddParagraph then
		container.__HookAddParagraph = true
		local Old = container.AddParagraph
		container.AddParagraph = function(self, arg1, arg2, ...)
			local el = Old(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			RecordElement(ctx, "Paragraph", title, el)
			return el
		end
	end

	if container.AddSlider and not container.__HookAddSlider then
		container.__HookAddSlider = true
		local Old = container.AddSlider
		container.AddSlider = function(self, arg1, arg2, ...)
			local el = Old(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			RecordElement(ctx, "Slider", title, el)
			return el
		end
	end

	if container.AddInput and not container.__HookAddInput then
		container.__HookAddInput = true
		local Old = container.AddInput
		container.AddInput = function(self, arg1, arg2, ...)
			local el = Old(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			RecordElement(ctx, "Input", title, el)
			return el
		end
	end

	if container.AddKeybind and not container.__HookAddKeybind then
		container.__HookAddKeybind = true
		local Old = container.AddKeybind
		container.AddKeybind = function(self, arg1, arg2, ...)
			local el = Old(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			RecordElement(ctx, "Keybind", title, el)
			return el
		end
	end

	if container.AddSection and not container.__SectionHooked then
		container.__SectionHooked = true
		local OldAddSection = container.AddSection
		container.AddSection = function(self, arg1, arg2, ...)
			local sec = OldAddSection(self, arg1, arg2, ...)
			local title = GetTitle(arg1, arg2)
			if ctx.SetSection then ctx.SetSection(title) end
			HookContainer(sec, ctx)
			RecordElement(ctx, "Section", title, sec)
			return sec
		end
		container.Section = function(self, ...)
			return self:AddSection(...)
		end
	end

	if container.AddToggle then container.Toggle = container.AddToggle end
	if container.AddDropdown then container.Dropdown = container.AddDropdown end
	if container.AddButton then container.Button = container.AddButton end
	if container.AddParagraph then container.Paragraph = container.AddParagraph end
	if container.AddSlider then container.Slider = container.AddSlider end
	if container.AddInput then container.Input = container.AddInput end
	if container.AddKeybind then container.Keybind = container.AddKeybind end

	if container.AddSection and not container.Section then
		container.Section = function(self, ...)
			return self:AddSection(...)
		end
	end

	return container
end

local SpriteSheet = "rbxassetid://118976126805967"
local Icons = {
	Search    = "rbxassetid://6031154871",
	Toggle    = "rbxassetid://7734091286",
	Slider    = "rbxassetid://6031280883",
	Dropdown  = "rbxassetid://7734053426",
	Button    = "rbxassetid://7733954611",
	Input     = "rbxassetid://7733920644",
	Section   = "rbxassetid://7733799901",
	Keybind   = "rbxassetid://7733920644",
	Misc      = "rbxassetid://7733954611",
	Paragraph = {
		Image = SpriteSheet,
		ImageRectSize = Vector2.new(64, 64),
		ImageRectOffset = Vector2.new(448, 832)
	}
}

function CustomizeLibrary(Window)
	local RootFrame = Window.Root
	local TabHolder = Window.TabHolder
	local TabContainer = TabHolder.Parent
	local Sidebar = TabContainer.Parent

	local function Create(class, properties)
		local inst = Instance.new(class)
		for k, v in pairs(properties) do inst[k] = v end
		return inst
	end

	TabHolder.CanvasSize = UDim2.new(0,0,0,0)
	TabContainer.Position = UDim2.new(0, 12, 0, 60)
	TabContainer.Size = UDim2.new(0, Window.TabWidth, 1, -115)

	local ListPadding = TabHolder:FindFirstChildOfClass("UIPadding") or Create("UIPadding", {Parent = TabHolder})
	ListPadding.PaddingTop = UDim.new(0, 4)
	ListPadding.PaddingBottom = UDim.new(0, 8)

	local SearchTab = Create("TextButton", {
		Name = "SearchTab",
		Parent = TabHolder,
		LayoutOrder = -10,
		BackgroundColor3 = Sidebar.BackgroundColor3,
		BackgroundTransparency = 1,
		BorderSizePixel = 0,
		Size = UDim2.new(1, 0, 0, 32),
		AutoButtonColor = false,
		Text = ""
	})
	Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = SearchTab})
	local SearchStroke = Create("UIStroke", {Thickness = 1, Transparency = 0.8, Parent = SearchTab})

	local SearchIcon = Create("ImageLabel", {
		Parent = SearchTab,
		BackgroundTransparency = 1,
		Image = Icons.Search,
		ImageColor3 = Color3.fromRGB(160, 160, 160),
		Position = UDim2.new(0, 10, 0.5, -7),
		Size = UDim2.fromOffset(16, 16)
	})

	local SearchText = Create("TextLabel", {
		Parent = SearchTab,
		BackgroundTransparency = 1,
		Text = "Search...",
		Font = Enum.Font.Gotham,
		TextColor3 = Color3.fromRGB(160, 160, 160),
		TextSize = 13,
		TextXAlignment = Enum.TextXAlignment.Left,
		Position = UDim2.new(0, 32, 0, 0),
		Size = UDim2.new(1, -32, 1, 0)
	})

	local ProfileFrame = Create("Frame", {
		Name = "UserProfile",
		Parent = Sidebar,
		BackgroundColor3 = Sidebar.BackgroundColor3,
		BackgroundTransparency = 1,
		BorderSizePixel = 0,
		Position = UDim2.new(0, 0, 1, -50),
		Size = UDim2.new(1, 0, 0, 50),
		ZIndex = 5
	})

	local Avatar = Create("ImageLabel", {
		Parent = ProfileFrame,
		Size = UDim2.fromOffset(32, 32),
		Position = UDim2.new(0, 12, 0.5, -16),
		BackgroundColor3 = Color3.fromRGB(0,0,0),
		BackgroundTransparency = 1,
		Image = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
	})
	Create("UICorner", {CornerRadius = UDim.new(1,0), Parent = Avatar})
	local AvatarStroke = Create("UIStroke", {Thickness = 1, Transparency = 0.5, Parent = Avatar, ApplyStrokeMode = Enum.ApplyStrokeMode.Border})

	local DisplayName = Create("TextLabel", {
		Parent = ProfileFrame,
		BackgroundTransparency = 1,
		Text = LocalPlayer.DisplayName,
		Font = Enum.Font.GothamBold,
		TextColor3 = Color3.fromRGB(240, 240, 240),
		TextSize = 13,
		TextXAlignment = Enum.TextXAlignment.Left,
		Position = UDim2.new(0, 54, 0, 8),
		Size = UDim2.new(1, -60, 0, 14)
	})

	local UserName = Create("TextLabel", {
		Parent = ProfileFrame,
		BackgroundTransparency = 1,
		Text = "@" .. LocalPlayer.Name,
		Font = Enum.Font.Gotham,
		TextColor3 = Color3.fromRGB(160, 160, 160),
		TextSize = 11,
		TextXAlignment = Enum.TextXAlignment.Left,
		Position = UDim2.new(0, 54, 0, 22),
		Size = UDim2.new(1, -60, 0, 12)
	})

	local SpotlightOverlay = Create("Frame", {
		Name = "SpotlightOverlay",
		Parent = RootFrame,
		BackgroundColor3 = Color3.new(0,0,0),
		BackgroundTransparency = 1,
		Size = UDim2.new(1,0,1,0),
		ZIndex = 10000,
		Visible = false
	})

	local SpotlightFrame = Create("Frame", {
		Parent = SpotlightOverlay,
		AnchorPoint = Vector2.new(0.5,0.5),
		Position = UDim2.new(0.5,0,0.4,0),
		Size = UDim2.new(0.85,0,0,45),
		BackgroundColor3 = Color3.fromRGB(25,25,25),
		BorderSizePixel = 0,
		ClipsDescendants = true,
		ZIndex = 10001
	})
	Create("UICorner", {CornerRadius = UDim.new(0,8), Parent = SpotlightFrame})
	local SpotlightStroke = Create("UIStroke", {Thickness = 1, Transparency = 0, Parent = SpotlightFrame})
	local SpotlightGradient = Create("UIGradient", {Parent = SpotlightFrame})

	local SpotInput = Create("TextBox", {
		Parent = SpotlightFrame,
		BackgroundTransparency = 1,
		Position = UDim2.new(0,42,0,0),
		Size = UDim2.new(1,-45,0,45),
		Font = Enum.Font.GothamMedium,
		Text = "",
		PlaceholderText = "Search features...",
		TextSize = 15,
		TextXAlignment = Enum.TextXAlignment.Left,
		ClearTextOnFocus = false,
		ZIndex = 10002
	})
	local SpotIcon = Create("ImageLabel", {
		Parent = SpotlightFrame,
		BackgroundTransparency = 1,
		Image = Icons.Search,
		Position = UDim2.new(0,12,0,11),
		Size = UDim2.fromOffset(22,22),
		ZIndex = 10002
	})

	local SpotSeparator = Create("Frame", {
		Parent = SpotlightFrame,
		BorderSizePixel = 0,
		Position = UDim2.new(0, 0, 0, 45),
		Size = UDim2.new(1, 0, 0, 1),
		ZIndex = 10002
	})

	local SpotResults = Create("ScrollingFrame", {
		Parent = SpotlightFrame,
		BackgroundTransparency = 1,
		Position = UDim2.new(0, 0, 0, 47),
		Size = UDim2.new(1, 0, 1, -47),
		ScrollBarThickness = 3,
		BorderSizePixel = 0,
		CanvasSize = UDim2.new(0,0,0,0),
		ZIndex = 10002
	})
	Create("UIListLayout", {Parent = SpotResults, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 2)})
	Create("UIPadding", {Parent = SpotResults, PaddingLeft = UDim.new(0,5), PaddingRight = UDim.new(0,5), PaddingTop = UDim.new(0,5), PaddingBottom = UDim.new(0,5)})

	local SettingsLabelRef, SettingsButtonRef, GradientRef = nil, nil, nil
	local CurrentFlashColor = Color3.fromRGB(255, 255, 255)

	local function UpdateColors()
		pcall(function()
			if not SettingsLabelRef or not SettingsButtonRef or not SettingsLabelRef.Parent then
				for _, inst in ipairs(RootFrame:GetDescendants()) do
					if inst:IsA("TextButton") then
						local label = inst:FindFirstChildWhichIsA("TextLabel", true)
						if label and label.Text == "Settings" then
							SettingsLabelRef = label
							SettingsButtonRef = inst
							break
						end
					end
				end
			end

			if not GradientRef or not GradientRef.Parent then
				for _, inst in ipairs(RootFrame:GetDescendants()) do
					if inst:IsA("UIGradient") then GradientRef = inst break end
				end
			end

			local TargetTextColor = Color3.fromRGB(240, 240, 240)
			local TargetBgColor = Color3.fromRGB(30, 30, 30)

			if SettingsLabelRef then TargetTextColor = SettingsLabelRef.TextColor3 end
			if SettingsButtonRef then
				TargetBgColor = SettingsButtonRef.BackgroundColor3
				CurrentFlashColor = TargetBgColor
			end

			local brightness = (TargetTextColor.R + TargetTextColor.G + TargetTextColor.B) / 3
			local SubColor = (brightness > 0.5) and Color3.fromRGB(160, 160, 160) or Color3.fromRGB(100, 100, 100)

			SearchText.TextColor3 = TargetTextColor
			SearchIcon.ImageColor3 = TargetTextColor
			DisplayName.TextColor3 = TargetTextColor
			UserName.TextColor3 = SubColor

			SpotInput.TextColor3 = TargetTextColor
			SpotIcon.ImageColor3 = TargetTextColor
			SpotInput.PlaceholderColor3 = SubColor
			SpotSeparator.BackgroundColor3 = SubColor

			if GradientRef then
				SpotlightGradient.Color = GradientRef.Color
				SpotlightGradient.Rotation = GradientRef.Rotation
				SpotlightFrame.BackgroundColor3 = Color3.new(1,1,1)
			else
				SpotlightFrame.BackgroundColor3 = TargetBgColor
			end

			local stroke = RootFrame:FindFirstChild("UIStroke")
			if stroke then
				SearchStroke.Color = stroke.Color
				AvatarStroke.Color = stroke.Color
				SpotlightStroke.Color = stroke.Color
			else
				SearchStroke.Transparency = 1
			end

			for _, btn in pairs(SpotResults:GetChildren()) do
				if btn:IsA("TextButton") then
					local t = btn:FindFirstChild("Title")
					if t then t.TextColor3 = TargetTextColor end
					local dot = btn:FindFirstChild("Dot")
					if dot then dot.TextColor3 = TargetTextColor end
					local tabL = btn:FindFirstChild("TabLabel")
					if tabL then tabL.TextColor3 = TargetTextColor end
					local icon = btn:FindFirstChild("Icon")
					if icon then icon.ImageColor3 = TargetTextColor end
					local str = btn:FindFirstChild("UIStroke")
					if str and btn:GetAttribute("Hovering") then str.Color = TargetTextColor end
				end
			end
		end)
	end
	RunService.RenderStepped:Connect(UpdateColors)

	local function FindVisualTargetByText(root, itemName)
		if not root then return end
		for _, desc in ipairs(root:GetDescendants()) do
			if desc:IsA("TextLabel") and desc.Text == itemName then
				local p = desc
				while p and p ~= root do
					if p.Parent and p.Parent:IsA("ScrollingFrame") then
						return desc
					end
					p = p.Parent
				end
				return desc
			end
		end
	end

	local function PickFlashTarget(node)
		if not node or typeof(node) ~= "Instance" then return nil end
		local n = node
		if n:IsA("TextLabel") then n = n.Parent end

		local best = nil
		local p = n
		while p and not p:IsA("ScrollingFrame") do
			if p:IsA("Frame") or p:IsA("TextButton") then
				best = p
				if p:FindFirstChildOfClass("UIStroke") or p:FindFirstChildOfClass("UICorner") then
					break
				end
			end
			p = p.Parent
		end
		return best or n
	end

	local function ScrollToTargetCentered(target)
		if not target then return end
		target = PickFlashTarget(target)
		if not target then return end

		local sf = target:FindFirstAncestorWhichIsA("ScrollingFrame")
		if not sf then return end

		local padTop = 0
		local pad = sf:FindFirstChildOfClass("UIPadding")
		if pad then padTop = pad.PaddingTop.Offset end

		local viewH = sf.AbsoluteWindowSize.Y
		local targetH = target.AbsoluteSize.Y

		local relY = (target.AbsolutePosition.Y - sf.AbsolutePosition.Y) + sf.CanvasPosition.Y - padTop
		local desiredY = relY - (viewH * 0.5) + (targetH * 0.5)

		local maxScroll = sf.AbsoluteCanvasSize.Y - sf.AbsoluteWindowSize.Y
		desiredY = math.clamp(desiredY, 0, math.max(0, maxScroll))

		sf.CanvasPosition = Vector2.new(sf.CanvasPosition.X, desiredY)

		local overlay = Instance.new("Frame")
		overlay.Name = "SearchFlashOverlay"
		overlay.BackgroundTransparency = 1
		overlay.BorderSizePixel = 0
		overlay.ZIndex = 99999
		overlay.Parent = RootFrame

		local rootAbs = RootFrame.AbsolutePosition
		local absPos = target.AbsolutePosition
		local absSize = target.AbsoluteSize

		overlay.Position = UDim2.fromOffset(absPos.X - rootAbs.X, absPos.Y - rootAbs.Y)
		overlay.Size = UDim2.fromOffset(absSize.X, absSize.Y)

		Instance.new("UICorner", overlay).CornerRadius = UDim.new(0, 6)

		local stroke = Instance.new("UIStroke")
		stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
		stroke.Thickness = 2
		stroke.Color = CurrentFlashColor
		stroke.Transparency = 1
		stroke.Parent = overlay

		task.spawn(function()
			for _ = 1, 3 do
				if not overlay.Parent then break end
				local t1 = TweenService:Create(stroke, TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Transparency = 0})
				t1:Play()
				t1.Completed:Wait()
				task.wait(0.04)
				local t2 = TweenService:Create(stroke, TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Transparency = 1})
				t2:Play()
				t2.Completed:Wait()
				task.wait(0.04)
			end
			if overlay then overlay:Destroy() end
		end)
	end

	local function ScrollToElement(itemName, frameObj)
		local target = frameObj
		if not target then
			target = FindVisualTargetByText(RootFrame, itemName)
		end
		ScrollToTargetCentered(target)
	end

	local function DeepIndexElements()
		local ContainerHolder = nil
		for _, v in pairs(RootFrame:GetDescendants()) do
			if v.Name == "ContainerHolder" then ContainerHolder = v break end
		end

		if not ContainerHolder then return end

		for _, page in pairs(ContainerHolder:GetChildren()) do
			if page:IsA("ScrollingFrame") then
				local tabName = "Unknown"
				local tabIndex = 1
				for idx, btn in pairs(TabHolder:GetChildren()) do
					if btn:IsA("GuiButton") and btn.LayoutOrder == page.LayoutOrder then
						local tl = btn:FindFirstChildOfClass("TextLabel")
						if tl then tabName = tl.Text end
						tabIndex = idx
						break
					end
				end

				local currentSection = tabName

				for _, element in pairs(page:GetChildren()) do
					if element:IsA("Frame") and element.Visible then
						if not ObjectSet[element] then
							local elType = "Misc"
							local title = "Unknown"

							local possibleTitle = element:FindFirstChild("Title") or element:FindFirstChildOfClass("TextLabel")
							if possibleTitle and possibleTitle:IsA("TextLabel") then
								title = possibleTitle.Text
							end

							if title ~= "Unknown" and title ~= "" then
								if element:FindFirstChild("Title") and element.Title.TextXAlignment == Enum.TextXAlignment.Center then
									elType = "Section"
									currentSection = title
								elseif element:FindFirstChild("Box") then elType = "Input"
								elseif element:FindFirstChild("Slider") then elType = "Slider"
								elseif element:FindFirstChild("Dropdown") then elType = "Dropdown"
								elseif element:FindFirstChild("Check") or element:FindFirstChild("Toggle") then elType = "Toggle"
								elseif element:FindFirstChild("Container") then elType = "Button"
								elseif element.Name == "Section" then elType = "Section"; currentSection = title
								elseif element.Name == "Paragraph" then elType = "Paragraph"
								end

								ObjectSet[element] = true
								table.insert(SearchIndex, {
									Name = title,
									Type = elType,
									Tab = tabName,
									Section = currentSection,
									TabIndex = tabIndex,
									Object = nil,
									Frame = element
								})
							end
						end
					end
				end
			end
		end
	end

	task.spawn(function()
		task.wait(2)
		DeepIndexElements()
	end)

	local function UpdateSearchResults()
		local query = SpotInput.Text:lower()
		for _, v in pairs(SpotResults:GetChildren()) do
			if v:IsA("TextButton") then v:Destroy() end
		end

		local hits = 0
		for _, item in ipairs(SearchIndex) do
			if query == "" or tostring(item.Name):lower():find(query, 1, true) then
				hits += 1

				local iconData = Icons[item.Type] or Icons.Misc

				local btn = Create("TextButton", {
					Parent = SpotResults,
					BackgroundColor3 = Sidebar.BackgroundColor3,
					BackgroundTransparency = 1,
					Size = UDim2.new(1, 0, 0, 32),
					Text = "",
					AutoButtonColor = false,
					ZIndex = 10005,
					Active = true
				})
				Create("UICorner", {CornerRadius = UDim.new(0, 4), Parent = btn})

				local btnStroke = Create("UIStroke", {
					Parent = btn,
					Thickness = 1,
					Transparency = 1,
					Color = SpotInput.TextColor3,
					ApplyStrokeMode = Enum.ApplyStrokeMode.Border
				})

				local iconImage = ""
				local iconRectSize = Vector2.new(0,0)
				local iconRectOffset = Vector2.new(0,0)

				if type(iconData) == "table" then
					iconImage = iconData.Image
					iconRectSize = iconData.ImageRectSize
					iconRectOffset = iconData.ImageRectOffset
				else
					iconImage = iconData
				end

				Create("ImageLabel", {
					Name = "Icon",
					Parent = btn,
					BackgroundTransparency = 1,
					Image = iconImage,
					ImageRectSize = iconRectSize,
					ImageRectOffset = iconRectOffset,
					ImageColor3 = SpotInput.TextColor3,
					Position = UDim2.new(0, 8, 0.5, -8),
					Size = UDim2.fromOffset(16, 16),
					ZIndex = 10006
				})

				local TitleLabel = Create("TextLabel", {
					Name = "Title",
					Parent = btn,
					BackgroundTransparency = 1,
					Text = item.Name,
					TextColor3 = SpotInput.TextColor3,
					Font = Enum.Font.GothamMedium,
					TextSize = 13,
					TextXAlignment = Enum.TextXAlignment.Left,
					AutomaticSize = Enum.AutomaticSize.X,
					Position = UDim2.new(0, 32, 0, 0),
					Size = UDim2.new(0, 0, 1, 0),
					ZIndex = 10006
				})

				local Dot = Create("TextLabel", {
					Name = "Dot",
					Parent = btn,
					BackgroundTransparency = 1,
					Text = "â€¢",
					TextColor3 = SpotInput.TextColor3,
					Font = Enum.Font.Gotham,
					TextSize = 13,
					TextXAlignment = Enum.TextXAlignment.Left,
					Position = UDim2.new(0, 0, 0, 0),
					Size = UDim2.new(0, 10, 1, 0),
					ZIndex = 10006
				})

				local displayPath = item.Tab
				if item.Section and item.Section ~= item.Tab then
					displayPath = item.Tab .. " > " .. item.Section
				end

				local TabLabel = Create("TextLabel", {
					Name = "TabLabel",
					Parent = btn,
					BackgroundTransparency = 1,
					Text = displayPath,
					TextColor3 = SpotInput.TextColor3,
					Font = Enum.Font.Gotham,
					TextSize = 12,
					TextXAlignment = Enum.TextXAlignment.Left,
					Position = UDim2.new(0, 0, 0, 0),
					Size = UDim2.new(0, 100, 1, 0),
					ZIndex = 10006
				})

				task.delay(0, function()
					local tW = TitleLabel.AbsoluteSize.X
					Dot.Position = UDim2.new(0, 32 + tW + 5, 0, 0)
					TabLabel.Position = UDim2.new(0, 32 + tW + 15, 0, 0)
				end)

				btn.MouseEnter:Connect(function()
					btn:SetAttribute("Hovering", true)
					TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0.95}):Play()
					TweenService:Create(btnStroke, TweenInfo.new(0.2), {Transparency = 0}):Play()
				end)
				btn.MouseLeave:Connect(function()
					btn:SetAttribute("Hovering", false)
					TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
					TweenService:Create(btnStroke, TweenInfo.new(0.2), {Transparency = 1}):Play()
				end)

				btn.MouseButton1Click:Connect(function()
					local ok = pcall(function() Window:SelectTab(item.TabIndex) end)
					if not ok then
						for _, tb in pairs(TabHolder:GetChildren()) do
							local tl = tb:FindFirstChildOfClass("TextLabel")
							if tl and tl.Text == item.Tab then
								for _, c in pairs(getconnections(tb.MouseButton1Click)) do c:Fire() end
								break
							end
						end
					end

					TweenService:Create(SpotlightOverlay, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
					TweenService:Create(SpotlightFrame, TweenInfo.new(0.2), {Size = UDim2.new(0.85, 0, 0, 45)}):Play()
					task.wait(0.2)
					SpotlightOverlay.Visible = false
					SpotInput.Text = ""

					task.delay(0, function()
						ScrollToElement(item.Name, item.Frame)
					end)
				end)
			end
		end

		local totalHeight = math.min(hits * 34 + 52, 300)
		if hits == 0 then totalHeight = 45 end
		TweenService:Create(SpotlightFrame, TweenInfo.new(0.1), {Size = UDim2.new(0.85, 0, 0, totalHeight)}):Play()
		SpotResults.CanvasSize = UDim2.new(0, 0, 0, hits * 34)
	end

	SpotInput:GetPropertyChangedSignal("Text"):Connect(UpdateSearchResults)

	SearchTab.MouseButton1Click:Connect(function()
		SpotlightOverlay.Visible = true
		SpotInput:CaptureFocus()
		UpdateSearchResults()
	end)

	local CloseBtn = Create("TextButton", {
		Parent = SpotlightOverlay,
		Size = UDim2.new(1,0,1,0),
		BackgroundTransparency = 1,
		Text = "",
		ZIndex = 199
	})
	CloseBtn.MouseButton1Click:Connect(function()
		SpotlightOverlay.Visible = false
	end)
end

local function HookWindow(Window)
	if not Window or Window.__SearchHooked then return Window end
	Window.__SearchHooked = true

	local OriginalAddTab = Window.AddTab
	local CurrentTabIndex = 0

	Window.AddTab = function(self, tabOptions)
		CurrentTabIndex += 1
		local ThisTabIndex = CurrentTabIndex

		local Tab = OriginalAddTab(self, tabOptions)

		local TabName = tabOptions.Title or "Unknown"
		local CurrentSection = TabName

		local ctx = {
			TabName = TabName,
			TabIndex = ThisTabIndex,
			GetSection = function() return CurrentSection end,
			SetSection = function(v) CurrentSection = tostring(v or TabName) end
		}

		HookContainer(Tab, ctx)
		RecordElement(ctx, "Misc", TabName, Tab)

		return Tab
	end

	task.spawn(function()
		task.wait(0.1)
		CustomizeLibrary(Window)
	end)

	return Window
end

Library.CreateWindow = function(self, options)
	local Window = HookWindow(OriginalCreateWindow(self, options))
	Library.CurrentWindow = Window
	return Window
end

if OriginalWindowCtor then
	Library.Window = function(self, options)
		local Window = HookWindow(OriginalWindowCtor(self, options))
		Library.CurrentWindow = Window
		return Window
	end
end


local toggleGui = Instance.new("ScreenGui")
toggleGui.Name = "DuckyToggleGui"
toggleGui.ResetOnSpawn = false
toggleGui.DisplayOrder = 100
toggleGui.Parent = (RunService:IsStudio() and LocalPlayer:WaitForChild("PlayerGui") or CoreGui)

local toggleBtn = Instance.new("ImageButton")
local normalSize = UDim2.new(0, 150, 0, 150)
local pressedSize = UDim2.new(0, 135, 0, 135)

toggleBtn.Size = normalSize
toggleBtn.AnchorPoint = Vector2.new(1, 0)
toggleBtn.Position = UDim2.new(1, -10, 0, 0) 
toggleBtn.BackgroundTransparency = 1
toggleBtn.Image = "rbxassetid://116073591672187"
toggleBtn.Parent = toggleGui
toggleBtn.Active = true

local dragging = false
local dragInput, mousePos, framePos

local function isInteraction(input)
    return input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch
end

toggleBtn.InputBegan:Connect(function(input)
    if isInteraction(input) then
        dragging = true
        mousePos = input.Position
        framePos = toggleBtn.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

toggleBtn.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - mousePos
        toggleBtn.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X,
                                      framePos.Y.Scale, framePos.Y.Offset + delta.Y)
    end
end)

toggleBtn.MouseButton1Down:Connect(function()
    TweenService:Create(toggleBtn, TweenInfo.new(0.1), {
        Size = pressedSize,
        ImageColor3 = Color3.fromRGB(200, 200, 255)
    }):Play()
end)

toggleBtn.MouseButton1Up:Connect(function()
    TweenService:Create(toggleBtn, TweenInfo.new(0.15, Enum.EasingStyle.Back), {
        Size = normalSize,
        ImageColor3 = Color3.fromRGB(255, 255, 255)
    }):Play()
end)

toggleBtn.MouseButton1Click:Connect(function()
    if Library.CurrentWindow then
        Library.CurrentWindow.Root.Visible = not Library.CurrentWindow.Root.Visible
    end
end)

return Library
