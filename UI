local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- 1. Load the Base Fluent Library
local Library = loadstring(game:HttpGetAsync("https://github.com/ActualMasterOogway/Fluent-Renewed/releases/latest/download/Fluent.luau"))()

local SearchIndex = {}
local ObjectSet = {}

-- 2. Capture the Original Function cleanly
local OriginalCreateWindow = Library.CreateWindow

-- 3. Define the New Window Function
local function NewCreateWindow(self, options)
    local Window = OriginalCreateWindow(self, options)
    local OriginalAddTab = Window.AddTab
    local CurrentTabIndex = 0

    Window.AddTab = function(self, tabOptions)
        CurrentTabIndex = CurrentTabIndex + 1
        local ThisTabIndex = CurrentTabIndex

        local Tab = OriginalAddTab(self, tabOptions)
        
        -- Hook Elements to Index them
        local function HookElement(method, typeName)
            if Tab[method] then
                local OriginalMethod = Tab[method]
                Tab[method] = function(self, arg1, arg2, ...)
                    local Element = OriginalMethod(self, arg1, arg2, ...)
                    
                    local DisplayTitle = "Unknown"
                    if type(arg1) == "string" then DisplayTitle = arg1
                    elseif type(arg1) == "table" and arg1.Title then DisplayTitle = arg1.Title
                    elseif type(arg2) == "table" and arg2.Title then DisplayTitle = arg2.Title end

                    if not ObjectSet[Element] then
                        ObjectSet[Element] = true
                        table.insert(SearchIndex, {
                            Name = DisplayTitle,
                            Type = typeName,
                            Tab = tabOptions.Title or "Unknown",
                            TabIndex = ThisTabIndex,
                            Object = Element
                        })
                    end
                    return Element
                end
            end
        end

        HookElement("AddButton", "Button")
        HookElement("AddToggle", "Toggle")
        HookElement("AddSlider", "Slider")
        HookElement("AddDropdown", "Dropdown")
        HookElement("AddInput", "Input")
        HookElement("AddParagraph", "Paragraph")
        HookElement("AddKeybind", "Keybind")

        return Tab
    end

    -- Inject Search UI
    task.spawn(function()
        task.wait(0.1)
        
        local RootFrame = Window.Root
        local TabHolder = Window.TabHolder
        local Sidebar = TabHolder.Parent.Parent -- Adjust based on theme if needed

        -- Search Button
        local SearchTab = Instance.new("TextButton")
        SearchTab.Name = "SearchTab"
        SearchTab.Parent = TabHolder
        SearchTab.LayoutOrder = -10
        SearchTab.BackgroundTransparency = 1
        SearchTab.Size = UDim2.new(1, 0, 0, 32)
        SearchTab.Text = ""
        
        local Icon = Instance.new("ImageLabel")
        Icon.Parent = SearchTab
        Icon.Image = "rbxassetid://6031154871" -- Search Icon
        Icon.BackgroundTransparency = 1
        Icon.Position = UDim2.new(0, 10, 0.5, -8)
        Icon.Size = UDim2.fromOffset(16, 16)
        Icon.ImageColor3 = Color3.fromRGB(150, 150, 150)

        local Label = Instance.new("TextLabel")
        Label.Parent = SearchTab
        Label.Text = "Search..."
        Label.BackgroundTransparency = 1
        Label.Position = UDim2.new(0, 35, 0, 0)
        Label.Size = UDim2.new(1, -35, 1, 0)
        Label.TextColor3 = Color3.fromRGB(150, 150, 150)
        Label.Font = Enum.Font.Gotham
        Label.TextSize = 14
        Label.TextXAlignment = Enum.TextXAlignment.Left

        -- Spotlight Overlay
        local Overlay = Instance.new("Frame")
        Overlay.Parent = RootFrame
        Overlay.Size = UDim2.new(1, 0, 1, 0)
        Overlay.BackgroundColor3 = Color3.new(0,0,0)
        Overlay.BackgroundTransparency = 0.3
        Overlay.Visible = false
        Overlay.ZIndex = 100

        local SpotFrame = Instance.new("Frame")
        SpotFrame.Parent = Overlay
        SpotFrame.Size = UDim2.new(0.8, 0, 0, 40)
        SpotFrame.Position = UDim2.new(0.5, 0, 0.2, 0)
        SpotFrame.AnchorPoint = Vector2.new(0.5, 0)
        SpotFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        
        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 6)
        UICorner.Parent = SpotFrame

        local Input = Instance.new("TextBox")
        Input.Parent = SpotFrame
        Input.Size = UDim2.new(1, -10, 1, 0)
        Input.Position = UDim2.new(0, 10, 0, 0)
        Input.BackgroundTransparency = 1
        Input.Text = ""
        Input.PlaceholderText = "Type to search..."
        Input.TextColor3 = Color3.new(1,1,1)
        Input.Font = Enum.Font.Gotham
        Input.TextSize = 14
        Input.TextXAlignment = Enum.TextXAlignment.Left

        local ResultsFrame = Instance.new("ScrollingFrame")
        ResultsFrame.Parent = SpotFrame
        ResultsFrame.Size = UDim2.new(1, 0, 0, 0) -- Auto resized
        ResultsFrame.Position = UDim2.new(0, 0, 1, 5)
        ResultsFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        ResultsFrame.BorderSizePixel = 0
        ResultsFrame.Visible = false
        
        local ResLayout = Instance.new("UIListLayout")
        ResLayout.Parent = ResultsFrame
        ResLayout.SortOrder = Enum.SortOrder.LayoutOrder

        -- Logic
        SearchTab.MouseButton1Click:Connect(function()
            Overlay.Visible = true
            Input:CaptureFocus()
        end)

        Overlay.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                -- Close if clicked outside the box
                local mousePos = input.Position
                local fPos = SpotFrame.AbsolutePosition
                local fSize = SpotFrame.AbsoluteSize
                if mousePos.X < fPos.X or mousePos.X > fPos.X + fSize.X or mousePos.Y < fPos.Y or mousePos.Y > fPos.Y + fSize.Y + ResultsFrame.AbsoluteSize.Y then
                    Overlay.Visible = false
                end
            end
        end)

        Input:GetPropertyChangedSignal("Text"):Connect(function()
            local query = Input.Text:lower()
            
            -- Clear previous
            for _, c in pairs(ResultsFrame:GetChildren()) do
                if c:IsA("TextButton") then c:Destroy() end
            end

            if query == "" then
                ResultsFrame.Visible = false
                return 
            end

            local hits = 0
            for _, item in ipairs(SearchIndex) do
                if item.Name:lower():find(query) then
                    hits = hits + 1
                    local btn = Instance.new("TextButton")
                    btn.Parent = ResultsFrame
                    btn.Size = UDim2.new(1, 0, 0, 30)
                    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                    btn.Text = "  " .. item.Name .. " (" .. item.Tab .. ")"
                    btn.TextColor3 = Color3.new(1,1,1)
                    btn.Font = Enum.Font.Gotham
                    btn.TextSize = 13
                    btn.TextXAlignment = Enum.TextXAlignment.Left
                    
                    btn.MouseButton1Click:Connect(function()
                        Overlay.Visible = false
                        Window:SelectTab(item.TabIndex)
                        
                        -- Scroll and Flash
                        if item.Object and item.Object.Frame then
                            local target = item.Object.Frame
                            local scrollContainer = target.Parent.Parent -- Usually container -> scrollframe
                            
                            if scrollContainer:IsA("ScrollingFrame") then
                                scrollContainer.CanvasPosition = Vector2.new(0, target.AbsolutePosition.Y - scrollContainer.AbsolutePosition.Y + scrollContainer.CanvasPosition.Y)
                            end

                            -- Flash Effect
                            local oldColor = target.BackgroundColor3
                            for i = 1, 3 do
                                target.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
                                task.wait(0.1)
                                target.BackgroundColor3 = oldColor
                                task.wait(0.1)
                            end
                        end
                    end)
                end
            end

            if hits > 0 then
                ResultsFrame.Visible = true
                ResultsFrame.Size = UDim2.new(1, 0, 0, math.min(hits * 30, 200))
                ResultsFrame.CanvasSize = UDim2.new(0, 0, 0, hits * 30)
            else
                ResultsFrame.Visible = false
            end
        end)
    end)

    return Window
end

-- 4. Apply the Override to BOTH .CreateWindow and .Window
Library.CreateWindow = NewCreateWindow
Library.Window = NewCreateWindow -- THIS IS THE CRITICAL FIX FOR TAP SIMULATOR

-- 5. Return the modified library
return Library
