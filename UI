local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

local Library = loadstring(game:HttpGetAsync("https://github.com/ActualMasterOogway/Fluent-Renewed/releases/latest/download/Fluent.luau"))()

local SearchIndex = {}
local ObjectSet = {}

local OriginalCreateWindow = Library.CreateWindow

local function NewCreateWindow(self, options)
    local Window = OriginalCreateWindow(self, options)
    
    local OriginalAddTab = Window.AddTab
    local CurrentTabIndex = 0

    Window.AddTab = function(self, tabOptions)
        CurrentTabIndex = CurrentTabIndex + 1
        local ThisTabIndex = CurrentTabIndex

        local Tab = OriginalAddTab(self, tabOptions)
        
        local function GetTitle(arg1, arg2)
            if type(arg2) == "table" and arg2.Title then return arg2.Title end
            if type(arg1) == "table" and arg1.Title then return arg1.Title end
            if type(arg1) == "string" then return arg1 end
            return "No Title"
        end

        local function HookElement(method, typeName)
            if Tab[method] then
                local OriginalMethod = Tab[method]
                Tab[method] = function(self, arg1, arg2, ...)
                    local Element = OriginalMethod(self, arg1, arg2, ...)
                    local DisplayTitle = GetTitle(arg1, arg2)

                    if not ObjectSet[Element] then
                        ObjectSet[Element] = true
                        table.insert(SearchIndex, {
                            Name = DisplayTitle,
                            Type = typeName,
                            Tab = tabOptions.Title or "Unknown",
                            TabIndex = ThisTabIndex,
                            Object = Element
                        })
                    end

                    return Element
                end
            end
        end

        HookElement("AddButton", "Button")
        HookElement("AddToggle", "Toggle")
        HookElement("AddSlider", "Slider")
        HookElement("AddDropdown", "Dropdown")
        HookElement("AddInput", "Input")
        HookElement("AddParagraph", "Paragraph")
        HookElement("AddSection", "Section")
        HookElement("AddKeybind", "Keybind")

        return Tab
    end

    task.spawn(function()
        task.wait(0.1)
        
        local RootFrame = Window.Root
        local TabHolder = Window.TabHolder
        local Sidebar = TabHolder.Parent.Parent
        
        local SpriteSheet = "rbxassetid://118976126805967"
        local Icons = {
            Search    = "rbxassetid://6031154871",
            Misc      = "rbxassetid://7733954611"
        }

        local function Create(class, properties)
            local inst = Instance.new(class)
            for k, v in pairs(properties) do inst[k] = v end
            return inst
        end

        TabHolder.CanvasSize = UDim2.new(0,0,0,0)
        TabHolder.Parent.Position = UDim2.new(0, 12, 0, 60)
        TabHolder.Parent.Size = UDim2.new(0, Window.TabWidth, 1, -115)

        local SearchTab = Create("TextButton", {
            Name = "SearchTab",
            Parent = TabHolder,
            LayoutOrder = -10,
            BackgroundColor3 = Sidebar.BackgroundColor3,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 0, 32),
            AutoButtonColor = false,
            Text = ""
        })
        Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = SearchTab})
        
        Create("ImageLabel", {
            Parent = SearchTab,
            BackgroundTransparency = 1,
            Image = Icons.Search,
            ImageColor3 = Color3.fromRGB(160, 160, 160),
            Position = UDim2.new(0, 10, 0.5, -7),
            Size = UDim2.fromOffset(16, 16)
        })

        Create("TextLabel", {
            Parent = SearchTab,
            BackgroundTransparency = 1,
            Text = "Search...",
            Font = Enum.Font.Gotham,
            TextColor3 = Color3.fromRGB(160, 160, 160),
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left,
            Position = UDim2.new(0, 32, 0, 0),
            Size = UDim2.new(1, -32, 1, 0)
        })

        local SpotlightOverlay = Create("Frame", {
            Name = "SpotlightOverlay",
            Parent = RootFrame,
            BackgroundColor3 = Color3.new(0,0,0),
            BackgroundTransparency = 1,
            Size = UDim2.new(1,0,1,0),
            ZIndex = 10000,
            Visible = false
        })

        local SpotlightFrame = Create("Frame", {
            Parent = SpotlightOverlay,
            AnchorPoint = Vector2.new(0.5,0.5),
            Position = UDim2.new(0.5,0,0.4,0),
            Size = UDim2.new(0.85,0,0,45),
            BackgroundColor3 = Color3.fromRGB(25,25,25),
            BorderSizePixel = 0,
            ClipsDescendants = true,
            ZIndex = 10001
        })
        Create("UICorner", {CornerRadius = UDim.new(0,8), Parent = SpotlightFrame})
        
        local SpotInput = Create("TextBox", {
            Parent = SpotlightFrame,
            BackgroundTransparency = 1,
            Position = UDim2.new(0,42,0,0),
            Size = UDim2.new(1,-45,0,45),
            Font = Enum.Font.GothamMedium,
            Text = "",
            PlaceholderText = "Search features...",
            TextSize = 15,
            TextXAlignment = Enum.TextXAlignment.Left,
            ClearTextOnFocus = false,
            TextColor3 = Color3.fromRGB(240,240,240),
            ZIndex = 10002
        })
        
        Create("ImageLabel", {
            Parent = SpotlightFrame,
            BackgroundTransparency = 1,
            Image = Icons.Search,
            Position = UDim2.new(0,12,0,11),
            Size = UDim2.fromOffset(22,22),
            ZIndex = 10002
        })

        local SpotResults = Create("ScrollingFrame", {
            Parent = SpotlightFrame,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 0, 0, 47),
            Size = UDim2.new(1, 0, 1, -47),
            ScrollBarThickness = 3,
            BorderSizePixel = 0,
            CanvasSize = UDim2.new(0,0,0,0),
            ZIndex = 10002
        })
        Create("UIListLayout", {Parent = SpotResults, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 2)})
        Create("UIPadding", {Parent = SpotResults, PaddingLeft = UDim.new(0,5), PaddingRight = UDim.new(0,5), PaddingTop = UDim.new(0,5), PaddingBottom = UDim.new(0,5)})

        local function UpdateSearchResults()
            local query = SpotInput.Text:lower()
            for _, v in pairs(SpotResults:GetChildren()) do
                if v:IsA("GuiButton") then v:Destroy() end
            end

            local hits = 0
            for _, item in ipairs(SearchIndex) do
                if query == "" or item.Name:lower():find(query) then
                    hits = hits + 1
                    
                    local btn = Create("TextButton", {
                        Parent = SpotResults,
                        BackgroundColor3 = Sidebar.BackgroundColor3,
                        BackgroundTransparency = 1,
                        Size = UDim2.new(1, 0, 0, 32),
                        Text = "",
                        AutoButtonColor = false,
                        ZIndex = 10005
                    })
                    Create("UICorner", {CornerRadius = UDim.new(0, 4), Parent = btn})

                    Create("TextLabel", {
                        Parent = btn,
                        BackgroundTransparency = 1,
                        Text = item.Name,
                        TextColor3 = Color3.fromRGB(240, 240, 240),
                        Font = Enum.Font.GothamMedium,
                        TextSize = 13,
                        TextXAlignment = Enum.TextXAlignment.Left,
                        Position = UDim2.new(0, 32, 0, 0),
                        Size = UDim2.new(1, -32, 1, 0),
                        ZIndex = 10006
                    })
                    
                    local iconImg = Icons[item.Type] or Icons.Misc
                    Create("ImageLabel", {
                        Parent = btn,
                        BackgroundTransparency = 1,
                        Image = iconImg,
                        ImageColor3 = Color3.fromRGB(240, 240, 240),
                        Position = UDim2.new(0, 8, 0.5, -8),
                        Size = UDim2.fromOffset(16, 16),
                        ZIndex = 10006
                    })

                    btn.MouseButton1Click:Connect(function()
                        pcall(function() Window:SelectTab(item.TabIndex) end)
                        SpotlightOverlay.Visible = false
                        SpotInput.Text = ""

                        if item.Object and item.Object.Frame then
                            local target = item.Object.Frame
                            local scrollContainer = target:FindFirstAncestorWhichIsA("ScrollingFrame")
                            if scrollContainer then
                                local relY = target.AbsolutePosition.Y - scrollContainer.AbsolutePosition.Y
                                scrollContainer.CanvasPosition = Vector2.new(0, scrollContainer.CanvasPosition.Y + relY - (scrollContainer.AbsoluteWindowSize.Y / 2) + (target.AbsoluteSize.Y / 2))
                            end
                            
                            local FlashStroke = Instance.new("UIStroke")
                            FlashStroke.Color = Color3.fromRGB(255, 255, 255)
                            FlashStroke.Thickness = 2
                            FlashStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
                            FlashStroke.Parent = target
                            
                            task.spawn(function()
                                for i = 1, 3 do
                                    if not target or not target.Parent then break end
                                    TweenService:Create(FlashStroke, TweenInfo.new(0.15), {Transparency = 0}):Play()
                                    task.wait(0.2)
                                    TweenService:Create(FlashStroke, TweenInfo.new(0.15), {Transparency = 1}):Play()
                                    task.wait(0.2)
                                end
                                FlashStroke:Destroy()
                            end)
                        end
                    end)
                end
            end
            
            local totalHeight = math.min(hits * 34 + 52, 300)
            if hits == 0 then totalHeight = 45 end
            TweenService:Create(SpotlightFrame, TweenInfo.new(0.1), {Size = UDim2.new(0.85, 0, 0, totalHeight)}):Play()
            SpotResults.CanvasSize = UDim2.new(0, 0, 0, hits * 34)
        end

        SpotInput:GetPropertyChangedSignal("Text"):Connect(UpdateSearchResults)

        SearchTab.MouseButton1Click:Connect(function()
            SpotlightOverlay.Visible = true
            SpotInput:CaptureFocus()
            UpdateSearchResults()
        end)
        
        Create("TextButton", {
            Parent = SpotlightOverlay,
            Size = UDim2.new(1,0,1,0),
            BackgroundTransparency = 1,
            Text = "",
            ZIndex = 999
        }).MouseButton1Click:Connect(function()
            SpotlightOverlay.Visible = false
        end)
    end)

    return Window
end

Library.CreateWindow = NewCreateWindow
Library.Window = NewCreateWindow

return Library
